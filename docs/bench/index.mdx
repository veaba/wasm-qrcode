# åŸºå‡†æµ‹è¯•

import { useState, useMemo } from 'react';
import { BarChart, ComparisonTable, PerformanceCalculator } from '../components/BenchmarkCharts';

export const BenchmarkDashboard = () => {
  const [selectedPackages, setSelectedPackages] = useState(['node', 'bun']);
  const [selectedCategory, setSelectedCategory] = useState('single');

  const allData = {
    single: [
      { name: 'çŸ­æ–‡æœ¬', node: 10312, bun: 10872, rust: 17300 },
      { name: 'ä¸­ç­‰æ–‡æœ¬', node: 9662, bun: 13929, rust: 17300 },
      { name: 'é•¿æ–‡æœ¬', node: 2447, bun: 5306, rust: 15000 },
      { name: 'Unicode', node: 4117, bun: 14246, rust: 16000 },
    ],
    batch: [
      { name: '10 æ¡', node: 6110, bun: 15420, rust: 20000 },
      { name: '100 æ¡', node: 3000, bun: 12200, rust: 22780 },
      { name: '1000 æ¡', node: 3000, bun: 15000, rust: 25000 },
    ],
    output: [
      { name: 'SVG', node: 9827, bun: 17097, rust: 22270 },
      { name: 'Styled SVG', node: 4893, bun: 9696, rust: 18000 },
    ],
    error: [
      { name: 'L (ä½)', node: 8010, bun: 24367, rust: 27000 },
      { name: 'M (ä¸­)', node: 8431, bun: 24074, rust: 27200 },
      { name: 'Q (è¾ƒé«˜)', node: 8646, bun: 23341, rust: 30500 },
      { name: 'H (é«˜)', node: 10427, bun: 19596, rust: 30000 },
    ],
  };

  const categories = {
    single: 'å•æ¡ç”Ÿæˆ',
    batch: 'æ‰¹é‡ç”Ÿæˆ',
    output: 'è¾“å‡ºæ ¼å¼',
    error: 'çº é”™çº§åˆ«',
  };

  const packages = {
    node: { name: 'Node.js', color: '#339933' },
    bun: { name: 'Bun', color: '#fbf0df' },
    rust: { name: 'Rust', color: '#dea584' },
  };

  const currentData = allData[selectedCategory];

  const togglePackage = (pkg) => {
    setSelectedPackages(prev => 
      prev.includes(pkg) 
        ? prev.filter(p => p !== pkg)
        : [...prev, pkg]
    );
  };

  const filteredData = useMemo(() => {
    return currentData.map(item => {
      const filtered = { name: item.name };
      selectedPackages.forEach(pkg => {
        filtered[pkg] = item[pkg];
      });
      return filtered;
    });
  }, [currentData, selectedPackages]);

  return (
    <div style={{ padding: '1.5rem', backgroundColor: '#f8fafc', borderRadius: '8px', marginTop: '1.5rem' }}>
      <h2 style={{ marginTop: 0 }}>ğŸ”¬ äº¤äº’å¼æ€§èƒ½æ¯”è¾ƒ</h2>
      
      {/* ç±»åˆ«é€‰æ‹© */}
      <div style={{ marginBottom: '1.5rem' }}>
        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '14px', fontWeight: 500 }}>
          é€‰æ‹©æµ‹è¯•ç±»åˆ«
        </label>
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
          {Object.entries(categories).map(([key, label]) => (
            <button
              key={key}
              onClick={() => setSelectedCategory(key)}
              style={{
                padding: '0.5rem 1rem',
                borderRadius: '6px',
                border: 'none',
                cursor: 'pointer',
                backgroundColor: selectedCategory === key ? '#3b82f6' : '#e2e8f0',
                color: selectedCategory === key ? 'white' : '#475569',
                fontWeight: selectedCategory === key ? 600 : 400,
                transition: 'all 0.2s'
              }}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* åŒ…é€‰æ‹© */}
      <div style={{ marginBottom: '1.5rem' }}>
        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '14px', fontWeight: 500 }}>
          é€‰æ‹©è¦æ¯”è¾ƒçš„åŒ…
        </label>
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
          {Object.entries(packages).map(([key, pkg]) => (
            <button
              key={key}
              onClick={() => togglePackage(key)}
              style={{
                padding: '0.5rem 1rem',
                borderRadius: '6px',
                border: '2px solid ' + (selectedPackages.includes(key) ? pkg.color : '#e2e8f0'),
                cursor: 'pointer',
                backgroundColor: selectedPackages.includes(key) ? pkg.color : 'white',
                color: selectedPackages.includes(key) ? (key === 'bun' ? '#333' : 'white') : '#475569',
                fontWeight: selectedPackages.includes(key) ? 600 : 400,
                transition: 'all 0.2s'
              }}
            >
              {key === 'node' ? 'ğŸŸ¢' : key === 'bun' ? 'ğŸ¥Ÿ' : 'ğŸ¦€'} {pkg.name}
            </button>
          ))}
        </div>
      </div>

      {/* å›¾è¡¨ */}
      {selectedPackages.length > 0 && (
        <BarChart 
          data={filteredData} 
          title={`${categories[selectedCategory]}æ€§èƒ½å¯¹æ¯” (ops/s)`} 
        />
      )}

      {/* è¡¨æ ¼ */}
      {selectedPackages.length > 0 && (
        <ComparisonTable data={filteredData} />
      )}

      {selectedPackages.length === 0 && (
        <div style={{ textAlign: 'center', padding: '2rem', color: '#64748b' }}>
          è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåŒ…è¿›è¡Œæ¯”è¾ƒ
        </div>
      )}
    </div>
  );
};

export const QuickStats = () => {
  const stats = [
    { label: 'Node.js æœ€å¿«', value: 'çº é”™çº§åˆ« H', ops: '10,427 ops/s', color: '#339933' },
    { label: 'Bun æœ€å¿«', value: 'çº é”™çº§åˆ« L', ops: '24,367 ops/s', color: '#fbf0df', textDark: true },
    { label: 'Rust æœ€å¿«', value: 'SVG ç”Ÿæˆ', ops: '22,270 ops/s', color: '#dea584' },
  ];

  return (
    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginTop: '1.5rem' }}>
      {stats.map((stat) => (
        <div
          key={stat.label}
          style={{
            padding: '1.5rem',
            backgroundColor: stat.color,
            borderRadius: '8px',
            color: stat.textDark ? '#333' : 'white',
            textAlign: 'center',
            border: stat.textDark ? '1px solid #d4a373' : 'none'
          }}
        >
          <div style={{ fontSize: '12px', opacity: 0.9, marginBottom: '0.5rem' }}>{stat.label}</div>
          <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '0.25rem' }}>{stat.value}</div>
          <div style={{ fontSize: '14px', opacity: 0.8 }}>{stat.ops}</div>
        </div>
      ))}
    </div>
  );
};

æœ¬ç« èŠ‚åŒ…å«æ‰€æœ‰ QRCode åŒ…çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Šã€‚

---

## ğŸ”¬ äº¤äº’å¼æ€§èƒ½æ¯”è¾ƒ

ä½¿ç”¨ä¸‹é¢çš„å·¥å…·è‡ªå®šä¹‰æ¯”è¾ƒä¸åŒåŒ…çš„æ€§èƒ½ï¼š

<BenchmarkDashboard />

---

## ğŸ“Š å¿«é€Ÿç»Ÿè®¡

<QuickStats />

---

## æµ‹è¯•æŠ¥å‘Š

### [åç«¯åŒ…æ€§èƒ½æ¯”è¾ƒ](./backend-bench)

æ¯”è¾ƒ `@veaba/qrcode-node` å’Œ `@veaba/qrcode-bun` çš„æ€§èƒ½å·®å¼‚ã€‚

**ä¸»è¦å‘ç°**:
- Bun åœ¨å•æ¡ç”Ÿæˆä¸Šæ¯” Node.js å¿« 5% - 246%
- Bun åœ¨æ‰¹é‡ç”Ÿæˆä¸Šæ¯” Node.js å¿« 150% - 400%
- Bun åœ¨ SVG è¾“å‡ºä¸Šæ¯” Node.js å¿« 74% - 98%

### [å‰ç«¯åŒ…æ€§èƒ½æ¯”è¾ƒ](./front-bench)

æ¯”è¾ƒ `@veaba/qrcode-js` å’Œ `@veaba/qrcode-wasm` çš„æ€§èƒ½ç‰¹ç‚¹ã€‚

**ä¸»è¦å†…å®¹**:
- çº¯ TypeScript vs WASM å®ç°çš„å¯¹æ¯”
- åŒ…ä½“ç§¯å’Œå¯åŠ¨é€Ÿåº¦åˆ†æ
- ä½¿ç”¨åœºæ™¯å»ºè®®

### [Rust æ€§èƒ½æ¯”è¾ƒ](./compare-rust)

æ¯”è¾ƒ `@veaba/qrcode-rust` ä¸æµè¡Œçš„ `kennytm-qrcode` åº“ã€‚

**ä¸»è¦å‘ç°**:
- å•æ¡ç”Ÿæˆå¹³å‡è€—æ—¶: ~57.8 Âµs
- SVG ç”Ÿæˆå¹³å‡è€—æ—¶: ~44.9 Âµs
- ä¸åŒçº é”™çº§åˆ«çš„æ€§èƒ½è¡¨ç°

---

## æµ‹è¯•ç¯å¢ƒ

- **å¹³å°**: Windows
- **Node.js**: v20.19.4
- **Bun**: 1.3.0
- **Rust**: æœ€æ–°ç¨³å®šç‰ˆ

---

## è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åç«¯åŸºå‡†æµ‹è¯•
pnpm run benchmark:backend

# è¿è¡Œ Node.js åŸºå‡†æµ‹è¯•
pnpm run benchmark:node

# è¿è¡Œ Bun åŸºå‡†æµ‹è¯•
pnpm run benchmark:bun

# è¿è¡Œ Rust åŸºå‡†æµ‹è¯•
pnpm run benchmark:rust

# è¿è¡Œå‰ç«¯æµ‹è¯•
pnpm run test:browser
```

---

## æ•°æ®æ–‡ä»¶

åŸºå‡†æµ‹è¯•çš„åŸå§‹æ•°æ®æ–‡ä»¶ä¿å­˜åœ¨ï¼š

- `/docs/public/benchmark_node_result.json` - Node.js æµ‹è¯•ç»“æœ
- `/docs/public/benchmark_bun_result.json` - Bun æµ‹è¯•ç»“æœ
- `/docs/public/benchmark_rust_result.json` - Rust æµ‹è¯•ç»“æœ
- `/docs/public/benchmark_summary.json` - æ±‡æ€»æŠ¥å‘Š

---

*æœ€åæ›´æ–°*: 2026-02-01

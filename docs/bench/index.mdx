# åŸºå‡†æµ‹è¯•

import { useState, useMemo } from 'react';
import { BarChart, ComparisonTable, PerformanceCalculator } from '../components/BenchmarkCharts';

export const BenchmarkDashboard = () => {
  const [selectedPackages, setSelectedPackages] = useState(['node', 'bun']);
  const [selectedCategory, setSelectedCategory] = useState('single');

  const allData = {
    single: [
      { name: 'çŸ­æ–‡æœ¬', node: 12078, bun: 14287, rust: 54283 },
      { name: 'ä¸­ç­‰æ–‡æœ¬', node: 10580, bun: 14910, rust: 38696 },
      { name: 'é•¿æ–‡æœ¬', node: 3043, bun: 5924, rust: 9303 },
      { name: 'Unicode', node: 8553, bun: 14588, rust: 12000 },
    ],
    batch: [
      { name: '10 æ¡', node: 10980, bun: 14870, rust: 25000 },
      { name: '100 æ¡', node: 5300, bun: 12800, rust: 22780 },
      { name: '1000 æ¡', node: 5000, bun: 13000, rust: 25000 },
    ],
    output: [
      { name: 'SVG', node: 10150, bun: 18003, rust: 92486 },
      { name: 'Styled SVG', node: 5374, bun: 10006, rust: 18000 },
    ],
    error: [
      { name: 'L (ä½)', node: 8619, bun: 27640, rust: 61368 },
      { name: 'M (ä¸­)', node: 10476, bun: 22093, rust: 41950 },
      { name: 'Q (è¾ƒé«˜)', node: 7746, bun: 18726, rust: 49062 },
      { name: 'H (é«˜)', node: 8871, bun: 14344, rust: 47436 },
    ],
  };

  const categories = {
    single: 'å•æ¡ç”Ÿæˆ',
    batch: 'æ‰¹é‡ç”Ÿæˆ',
    output: 'è¾“å‡ºæ ¼å¼',
    error: 'çº é”™çº§åˆ«',
  };

  const packages = {
    node: { name: 'Node.js', color: '#339933' },
    bun: { name: 'Bun', color: '#fbf0df' },
    rust: { name: 'Rust', color: '#dea584' },
  };

  const currentData = allData[selectedCategory];

  const togglePackage = (pkg) => {
    setSelectedPackages(prev => 
      prev.includes(pkg) 
        ? prev.filter(p => p !== pkg)
        : [...prev, pkg]
    );
  };

  const filteredData = useMemo(() => {
    return currentData.map(item => {
      const filtered = { name: item.name };
      selectedPackages.forEach(pkg => {
        filtered[pkg] = item[pkg];
      });
      return filtered;
    });
  }, [currentData, selectedPackages]);

  return (
    <div style={{ padding: '1.5rem', backgroundColor: '#f8fafc', borderRadius: '8px', marginTop: '1.5rem' }}>
      <h2 style={{ marginTop: 0 }}>ğŸ”¬ äº¤äº’å¼æ€§èƒ½æ¯”è¾ƒ</h2>
      
      {/* ç±»åˆ«é€‰æ‹© */}
      <div style={{ marginBottom: '1.5rem' }}>
        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '14px', fontWeight: 500 }}>
          é€‰æ‹©æµ‹è¯•ç±»åˆ«
        </label>
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
          {Object.entries(categories).map(([key, label]) => (
            <button
              key={key}
              onClick={() => setSelectedCategory(key)}
              style={{
                padding: '0.5rem 1rem',
                borderRadius: '6px',
                border: 'none',
                cursor: 'pointer',
                backgroundColor: selectedCategory === key ? '#3b82f6' : '#e2e8f0',
                color: selectedCategory === key ? 'white' : '#475569',
                fontWeight: selectedCategory === key ? 600 : 400,
                transition: 'all 0.2s'
              }}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* åŒ…é€‰æ‹© */}
      <div style={{ marginBottom: '1.5rem' }}>
        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '14px', fontWeight: 500 }}>
          é€‰æ‹©è¦æ¯”è¾ƒçš„åŒ…
        </label>
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
          {Object.entries(packages).map(([key, pkg]) => (
            <button
              key={key}
              onClick={() => togglePackage(key)}
              style={{
                padding: '0.5rem 1rem',
                borderRadius: '6px',
                border: '2px solid ' + (selectedPackages.includes(key) ? pkg.color : '#e2e8f0'),
                cursor: 'pointer',
                backgroundColor: selectedPackages.includes(key) ? pkg.color : 'white',
                color: selectedPackages.includes(key) ? (key === 'bun' ? '#333' : 'white') : '#475569',
                fontWeight: selectedPackages.includes(key) ? 600 : 400,
                transition: 'all 0.2s'
              }}
            >
              {key === 'node' ? 'ğŸŸ¢' : key === 'bun' ? 'ğŸ¥Ÿ' : 'ğŸ¦€'} {pkg.name}
            </button>
          ))}
        </div>
      </div>

      {/* å›¾è¡¨ */}
      {selectedPackages.length > 0 && (
        <BarChart 
          data={filteredData} 
          title={`${categories[selectedCategory]}æ€§èƒ½å¯¹æ¯” (ops/s)`} 
        />
      )}

      {/* è¡¨æ ¼ */}
      {selectedPackages.length > 0 && (
        <ComparisonTable data={filteredData} />
      )}

      {selectedPackages.length === 0 && (
        <div style={{ textAlign: 'center', padding: '2rem', color: '#64748b' }}>
          è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåŒ…è¿›è¡Œæ¯”è¾ƒ
        </div>
      )}
    </div>
  );
};

export const QuickStats = () => {
  const stats = [
    { label: 'Node.js æœ€å¿«', value: 'çŸ­æ–‡æœ¬ç”Ÿæˆ', ops: '12,078 ops/s', color: '#339933' },
    { label: 'Bun æœ€å¿«', value: 'çº é”™çº§åˆ« L', ops: '27,640 ops/s', color: '#fbf0df', textDark: true },
    { label: 'Rust æœ€å¿«', value: 'SVG è¾“å‡º', ops: '92,486 ops/s', color: '#dea584' },
  ];

  return (
    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginTop: '1.5rem' }}>
      {stats.map((stat) => (
        <div
          key={stat.label}
          style={{
            padding: '1.5rem',
            backgroundColor: stat.color,
            borderRadius: '8px',
            color: stat.textDark ? '#333' : 'white',
            textAlign: 'center',
            border: stat.textDark ? '1px solid #d4a373' : 'none'
          }}
        >
          <div style={{ fontSize: '12px', opacity: 0.9, marginBottom: '0.5rem' }}>{stat.label}</div>
          <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '0.25rem' }}>{stat.value}</div>
          <div style={{ fontSize: '14px', opacity: 0.8 }}>{stat.ops}</div>
        </div>
      ))}
    </div>
  );
};

export const SVGValidationCard = () => {
  return (
    <div style={{ padding: '1.5rem', backgroundColor: '#f0fdf4', borderRadius: '8px', marginTop: '1.5rem', border: '1px solid #86efac' }}>
      <h3 style={{ marginTop: 0, color: '#166534' }}>âœ… SVG éªŒè¯ç»“æœ</h3>
      <p style={{ color: '#166534', marginBottom: '1rem' }}>
        ä½¿ç”¨ <code>bench/rust-tools</code> éªŒè¯å·¥å…·å¯¹ç”Ÿæˆçš„ SVG è¿›è¡ŒéªŒè¯ï¼š
      </p>
      
      <div style={{ backgroundColor: 'white', padding: '1rem', borderRadius: '6px', fontFamily: 'monospace', fontSize: '13px' }}>
        <div style={{ color: '#22c55e', fontWeight: 'bold' }}>âœ… @veaba/qrcode-rust</div>
        <div style={{ color: '#64748b', marginLeft: '1rem' }}>ç”Ÿæˆçš„ SVG å¯é€šè¿‡æ ‡å‡†äºŒç»´ç æ‰«æå™¨æ­£ç¡®è§£ç </div>
        
        <div style={{ color: '#22c55e', fontWeight: 'bold', marginTop: '0.5rem' }}>âœ… @veaba/qrcode-fast</div>
        <div style={{ color: '#64748b', marginLeft: '1rem' }}>ç”Ÿæˆçš„ SVG å¯é€šè¿‡æ ‡å‡†äºŒç»´ç æ‰«æå™¨æ­£ç¡®è§£ç ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</div>
      </div>
      
      <div style={{ marginTop: '1rem', fontSize: '13px', color: '#64748b' }}>
        éªŒè¯å‘½ä»¤: <code>cargo run --release --features validation --bin veaba-qr -- "Hello World"</code>
      </div>
    </div>
  );
};

æœ¬ç« èŠ‚åŒ…å«æ‰€æœ‰ QRCode åŒ…çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Šã€‚

---

## ğŸ”¬ äº¤äº’å¼æ€§èƒ½æ¯”è¾ƒ

ä½¿ç”¨ä¸‹é¢çš„å·¥å…·è‡ªå®šä¹‰æ¯”è¾ƒä¸åŒåŒ…çš„æ€§èƒ½ï¼š

<BenchmarkDashboard />

---

## ğŸ“Š å¿«é€Ÿç»Ÿè®¡

<QuickStats />

---

## âœ… SVG éªŒè¯

<SVGValidationCard />

---

## æµ‹è¯•æŠ¥å‘Š

### [åç«¯åŒ…æ€§èƒ½æ¯”è¾ƒ](./backend-bench)

æ¯”è¾ƒ `@veaba/qrcode-node` å’Œ `@veaba/qrcode-bun` çš„æ€§èƒ½å·®å¼‚ã€‚

**ä¸»è¦å‘ç°**:
- Bun åœ¨å•æ¡ç”Ÿæˆä¸Šæ¯” Node.js å¿« 19% - 81%
- Bun åœ¨æ‰¹é‡ç”Ÿæˆä¸Šæ¯” Node.js å¿« 43% - 171%
- Bun åœ¨ SVG è¾“å‡ºä¸Šæ¯” Node.js å¿« 36% - 44%

### [å‰ç«¯åŒ…æ€§èƒ½æ¯”è¾ƒ](./front-bench)

æ¯”è¾ƒ `@veaba/qrcode-js` å’Œ `@veaba/qrcode-wasm` çš„æ€§èƒ½ç‰¹ç‚¹ã€‚

**ä¸»è¦å†…å®¹**:
- çº¯ TypeScript vs WASM å®ç°çš„å¯¹æ¯”
- åŒ…ä½“ç§¯å’Œå¯åŠ¨é€Ÿåº¦åˆ†æ
- ä½¿ç”¨åœºæ™¯å»ºè®®

### [åç«¯ PK å¯¹æ¯”](./backend-pk)

å¤šåŒ…å¯¹æ¯”æµ‹è¯•ï¼ŒåŒ…å« Node.jsã€Bunã€Rust å®ç°ã€‚

**ä¸»è¦å‘ç°**:
- `@veaba/qrcode-fast` (Rust) åœ¨å•æ¡ç”Ÿæˆä¸Šæœ€å¿«
- `@veaba/qrcode-bun` åœ¨æ‰¹é‡ç”Ÿæˆä¸Šè¡¨ç°ä¼˜ç§€
- `@veaba/qrcode-rust` æ¯” `kennytm-qrcode` å¿« 8-10 å€

### [Rust æ€§èƒ½æ¯”è¾ƒ](./compare-rust)

æ¯”è¾ƒ `@veaba/qrcode-rust` ä¸æµè¡Œçš„ `kennytm-qrcode` åº“ã€‚

**ä¸»è¦å‘ç°**:
- å•æ¡ç”Ÿæˆå¹³å‡è€—æ—¶: ~51.0 Âµs (kennytm: ~438.3 Âµs)
- SVG ç”Ÿæˆå¹³å‡è€—æ—¶: ~34.7 Âµs
- æ¯” kennytm-qrcode å¿« **8-10 å€**

### [SVG ç”ŸæˆåŸºå‡†æµ‹è¯•](./svg-benchmark)

ä¸“é—¨çš„ SVG ç”Ÿæˆæ€§èƒ½æµ‹è¯•ï¼ŒåŒ…å«éªŒè¯ç»“æœã€‚

**ä¸»è¦å‘ç°**:
- `@veaba/qrcode-fast` æ¯” `kennytm-qrcode` å¿« **20-22 å€**
- éªŒè¯çŠ¶æ€: ç®€å•æ–‡æœ¬é€šè¿‡ï¼Œå¤æ‚æ–‡æœ¬å­˜åœ¨ Reed-Solomon é—®é¢˜
- è¯¦ç»†çš„æ€§èƒ½æ•°æ®å’Œ SVG æ–‡ä»¶å¯¹æ¯”

---

## æµ‹è¯•ç¯å¢ƒ

- **å¹³å°**: Windows
- **Node.js**: v20.19.4
- **Bun**: 1.3.0
- **Rust**: rustc 1.89.0

---

## è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åç«¯åŸºå‡†æµ‹è¯•
pnpm run benchmark:backend

# è¿è¡Œ Node.js åŸºå‡†æµ‹è¯•
pnpm run benchmark:node

# è¿è¡Œ Bun åŸºå‡†æµ‹è¯•
pnpm run benchmark:bun

# è¿è¡Œ Rust åŸºå‡†æµ‹è¯•
pnpm run benchmark:rust

# è¿è¡Œå‰ç«¯æµ‹è¯•
pnpm run test:browser

# ä½¿ç”¨ rust-tools éªŒè¯ SVG
cd bench/rust-tools
cargo run --release --features validation --bin veaba-qr -- "ä½ çš„æ–‡æœ¬"
```

---

## æ•°æ®æ–‡ä»¶

åŸºå‡†æµ‹è¯•çš„åŸå§‹æ•°æ®æ–‡ä»¶ä¿å­˜åœ¨ï¼š

- `/docs/public/benchmark_node_result.json` - Node.js æµ‹è¯•ç»“æœ
- `/docs/public/benchmark_bun_result.json` - Bun æµ‹è¯•ç»“æœ
- `/docs/public/backend_benchmark_pk.json` - PK å®Œæ•´å¯¹æ¯”ç»“æœ
- `/docs/public/backend_benchmark_pk_summary.json` - PK æ‘˜è¦ç»“æœ
- `/docs/public/benchmark_svg_rust.json` - SVG ç”Ÿæˆæµ‹è¯•åŸå§‹æ•°æ®

---

*æœ€åæ›´æ–°*: 2026-02-02

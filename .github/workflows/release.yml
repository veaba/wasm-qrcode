name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: 'Release Version'
        required: true
        default: 'latest'
        options:
          - next
          - beta
          - alpha
          - latest
      branch:
        description: 'Release Branch'
        required: true
        default: 'main'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    if: github.event_name == 'workflow_dispatch' || github.event.comment.body == '/release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 25
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install pnpm
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24  # npm OIDC requires CLI 11.5.1+
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: pnpm install

      - name: Build @veaba/qrcode-js-shared
        run: pnpm --filter @veaba/qrcode-js-shared build

      - name: Build @veaba/qrcode-wasm
        run: pnpm --filter @veaba/qrcode-wasm build

      - name: Build @veaba/qrcode-js
        run: pnpm --filter @veaba/qrcode-js build

      - name: Build @veaba/qrcode-node
        run: pnpm --filter @veaba/qrcode-node build

      - name: Build @veaba/qrcode-bun
        run: pnpm --filter @veaba/qrcode-bun build

      # ========================================
      # Publish Rust Crates to crates.io
      # ========================================
      # æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½® CARGO_REGISTRY_TOKEN
      # ä» https://crates.io/settings/tokens è·å–å¹¶æ·»åŠ åˆ°ä»“åº“ Secrets
      #
      # å‘å¸ƒé¡ºåºï¼ˆä¾èµ–å…³ç³»ï¼‰ï¼š
      # 1. qrcode-rust-shared (åŸºç¡€åº“ï¼Œæ— ä¾èµ–)
      # 2. qrcode-rust, qrcode-fast (éƒ½ä¾èµ– qrcode-rust-shared)
      #
      # æœ¬åœ°æµ‹è¯• --dry-run å‘½ä»¤ï¼š
      #   cargo publish -p qrcode-rust-shared --dry-run --registry crates-io
      #   cargo publish -p qrcode-rust --dry-run --registry crates-io
      #   cargo publish -p qrcode-fast --dry-run --registry crates-io
      #
      # æ³¨æ„ï¼šé¦–æ¬¡å‘å¸ƒæ—¶ï¼Œqrcode-rust å’Œ qrcode-fast çš„ --dry-run ä¼šå¤±è´¥ï¼Œ
      # å› ä¸º qrcode-rust-shared è¿˜æ²¡å‘å¸ƒåˆ° crates.ioã€‚è¿™æ˜¯æ­£å¸¸çš„ã€‚

      # Step 1: å‘å¸ƒåŸºç¡€åº“ qrcode-rust-shared
      - name: Publish qrcode-rust-shared to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "ğŸ“¦ Publishing qrcode-rust-shared..."
          cargo publish -p qrcode-rust-shared --token "$CARGO_REGISTRY_TOKEN"
          echo "âœ… qrcode-rust-shared published successfully"

      # Step 2: ç­‰å¾… crates.io ç´¢å¼•æ›´æ–°ï¼ˆé€šå¸¸éœ€è¦ 30-60 ç§’ï¼‰
      - name: Wait for crates.io index update
        run: |
          echo "â³ Waiting for crates.io index to update..."
          sleep 60
          echo "âœ… Proceeding with dependent crates"

      # Step 3: å‘å¸ƒä¾èµ–åº“ï¼ˆå¹¶è¡Œä½†å¸¦é‡è¯•ï¼‰
      - name: Publish qrcode-rust to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "ğŸ“¦ Publishing qrcode-rust..."
          # å¦‚æœå¤±è´¥ï¼Œç­‰å¾…åé‡è¯•ï¼ˆå¤„ç†ç´¢å¼•å»¶è¿Ÿï¼‰
          for i in 1 2 3; do
            if cargo publish -p qrcode-rust --token "$CARGO_REGISTRY_TOKEN"; then
              echo "âœ… qrcode-rust published successfully"
              exit 0
            fi
            echo "âš ï¸ Attempt $i failed, waiting 30s for index update..."
            sleep 30
          done
          echo "âŒ Failed to publish qrcode-rust after 3 attempts"
          exit 1
        continue-on-error: true

      - name: Publish qrcode-fast to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "ğŸ“¦ Publishing qrcode-fast..."
          # å¦‚æœå¤±è´¥ï¼Œç­‰å¾…åé‡è¯•ï¼ˆå¤„ç†ç´¢å¼•å»¶è¿Ÿï¼‰
          for i in 1 2 3; do
            if cargo publish -p qrcode-fast --token "$CARGO_REGISTRY_TOKEN"; then
              echo "âœ… qrcode-fast published successfully"
              exit 0
            fi
            echo "âš ï¸ Attempt $i failed, waiting 30s for index update..."
            sleep 30
          done
          echo "âŒ Failed to publish qrcode-fast after 3 attempts"
          exit 1
        continue-on-error: true

      - name: Create Release Pull Request or Publish
        uses: changesets/action@v1
        with:
          version: pnpm ci:version
          publish: pnpm ci:publish
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # æ³¨æ„ï¼šä½¿ç”¨ OIDC è®¤è¯ï¼Œä¸éœ€è¦ NODE_AUTH_TOKEN
          # ç¡®ä¿åœ¨ npmjs.com ä¸Šä¸ºæ¯ä¸ªåŒ…é…ç½®äº† Trusted Publisher:
          # https://www.npmjs.com/package/@veaba/xxx/access
          # Publisher é…ç½®: org=veaba, repo=qrcodes, workflow=release.yml
